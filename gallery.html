<!DOCTYPE html>
<html lang="en" class="bg-[#FFF5E1] min-h-screen flex flex-col">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Members Gallery – Uttar Bangla Loko Sanskriti</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    .thumb-container {
      position: relative;
      cursor: pointer;
    }
    .download-icon {
      position: absolute;
      bottom: 6px;
      right: 6px;
      background: rgba(0, 0, 0, 0.5);
      padding: 4px;
      border-radius: 4px;
      opacity: 0;
      transition: opacity 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
    .thumb-container:hover .download-icon {
      opacity: 1;
    }
    .download-icon svg {
      width: 20px;
      height: 20px;
      fill: #FFDB58;
    }
  </style>
</head>

<body class="flex flex-col flex-grow bg-[#FFF5E1] text-[#3E2723]">
  <!-- Navbar -->
  <nav class="bg-[#800000] text-[#FFDB58] px-4 py-3 flex justify-between items-center relative">
    <div class="text-xl font-bold">Uttar Bangla Loko Sanskriti</div>
    <div class="hidden md:flex space-x-4 items-center">
      <button id="dashboardBtn" class="py-1 px-3 bg-[#FFDB58] text-[#800000] rounded hover:bg-[#a00000] hover:text-[#FFDB58] transition font-semibold">Return to Dashboard</button>
      <button id="logoutBtn" class="py-1 px-3 bg-[#FFDB58] text-[#800000] rounded hover:bg-[#a00000] hover:text-[#FFDB58] transition font-semibold">Logout</button>
    </div>
    <button id="navToggle" class="block md:hidden focus:outline-none" aria-label="Toggle menu">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
      </svg>
    </button>

    <div id="mobileMenu" class="absolute right-4 top-12 bg-[#800000] text-[#FFDB58] border border-[#FFDB58] rounded shadow-md p-2 hidden flex flex-col space-y-2">
      <button id="dashboardBtnMobile" class="w-full text-left py-1 px-2 hover:bg-[#a00000] transition">Return to Dashboard</button>
      <button id="logoutBtnMobile" class="w-full text-left py-1 px-2 hover:bg-[#a00000] transition">Logout</button>
    </div>
  </nav>

  <!-- Gallery -->
  <main class="flex-grow p-4 flex flex-col items-center">
    <div id="gallery" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 w-full max-w-5xl"></div>
  </main>

  <!-- Fullscreen Overlay -->
  <div id="fullscreenOverlay" class="fixed inset-0 bg-black bg-opacity-90 hidden items-center justify-center z-50 flex-col p-4">
    <img id="fullscreenImg" src="" alt="Fullscreen" class="max-h-full max-w-full mb-4 rounded shadow-lg" />
    <div class="flex space-x-4 mb-4">
      <button id="prevBtn" class="text-[#FFDB58] bg-[#800000] p-2 rounded hover:bg-[#a00000] transition" aria-label="Previous image">&larr; Prev</button>
      <button id="nextBtn" class="text-[#FFDB58] bg-[#800000] p-2 rounded hover:bg-[#a00000] transition" aria-label="Next image">Next &rarr;</button>
    </div>
    <div class="flex space-x-4 mb-4">
      <a id="downloadLink" href="#" download class="text-[#FFDB58] bg-[#800000] p-2 rounded hover:bg-[#a00000] transition flex items-center space-x-1" title="Download">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M12 12v8m0 0l-4-4m4 4l4-4m-4-12v8" />
        </svg>
        <span>Download</span>
      </a>
      <button id="shareBtn" class="text-[#800000] bg-[#FFDB58] p-2 rounded hover:bg-[#a00000] transition" title="Share image URL">Share</button>
      <button id="exitFullscreen" class="text-[#800000] bg-[#FFDB58] p-2 rounded hover:bg-[#a00000] transition">Close</button>
    </div>
    <p id="idleMessage" class="mt-6 text-[#FFDB58] text-sm hidden">Tap or swipe to navigate images</p>
  </div>

  <!-- Footer -->
  <footer class="bg-[#800000] text-[#FFDB58] py-4 text-center">
    &copy; 2025 Uttar Bangla Loko Sanskriti – All rights reserved.
  </footer>

  <!-- Script -->
  <script>
    const webAppURL = "https://script.google.com/macros/s/AKfycbyWuQ06UMiOpSQDS2YhsT6sPHjPr0cIPpDKIUF6NUnHyJEzo0tfo8fc0ZHjtpZryRshGQ/exec";

    // Session check function (unchanged)
    function checkSession() {
      const user = JSON.parse(localStorage.getItem("loggedInUser"));
      if (!user || Date.now() > user.sessionExpiry) {
        alert("Session expired. Please login again.");
        localStorage.removeItem("loggedInUser");
        window.location.href = "member.html";
        return false;
      }
      return true;
    }

    let imageList = [];

    async function loadImages() {
      try {
        const res = await fetch(`${webAppURL}?action=getGalleryImages`);
        if (!res.ok) throw new Error('Network response was not ok');
        imageList = await res.json();
        renderGallery();
      } catch (err) {
        console.error('Failed to load images:', err);
        alert('Failed to load gallery images. Please try again later.');
      }
    }

    function renderGallery() {
      const gallery = document.getElementById('gallery');
      gallery.innerHTML = "";

      imageList.forEach((item, idx) => {
        const container = document.createElement('div');
        container.className = "thumb-container rounded shadow hover:shadow-lg transition relative";

        const thumb = document.createElement('img');
        thumb.src = item.viewUrl;
        thumb.alt = item.name;
        thumb.className = 'rounded w-full h-48 object-cover';
        thumb.loading = 'lazy';
        thumb.addEventListener('click', () => openFullscreen(idx));
        container.appendChild(thumb);

        const downloadLink = document.createElement('a');
        downloadLink.href = item.downloadUrl;
        downloadLink.download = item.name;
        downloadLink.title = "Download image";
        downloadLink.className = "download-icon";
        downloadLink.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M5 20h14v-2H5v2zm7-18l-5 5h3v4h4v-4h3l-5-5z"/>
          </svg>`;
        container.appendChild(downloadLink);

        gallery.appendChild(container);
      });
    }

    // Navbar mobile toggle
    document.getElementById('navToggle').addEventListener('click', () => {
      document.getElementById('mobileMenu').classList.toggle('hidden');
    });

    // Logout buttons
    document.getElementById('logoutBtn').addEventListener('click', logout);
    document.getElementById('logoutBtnMobile').addEventListener('click', logout);
    function logout() {
      localStorage.removeItem("loggedInUser");
      window.location.href = "member.html";
    }

    // Dashboard buttons
    document.getElementById('dashboardBtn').addEventListener('click', () => {
      window.location.href = "dashboard.html";
    });
    document.getElementById('dashboardBtnMobile').addEventListener('click', () => {
      window.location.href = "dashboard.html";
    });

    // Fullscreen navigation
    let currentIndex = 0;

    function openFullscreen(idx) {
      currentIndex = idx;
      const img = imageList[idx];
      document.getElementById("fullscreenImg").src = img.viewUrl;
      document.getElementById("fullscreenImg").alt = img.name;
      document.getElementById("downloadLink").href = img.downloadUrl;
      document.getElementById("downloadLink").download = img.name;
      document.getElementById("fullscreenOverlay").classList.remove("hidden");
    }

    document.getElementById("exitFullscreen").addEventListener("click", () => {
      document.getElementById("fullscreenOverlay").classList.add("hidden");
    });

    document.getElementById("prevBtn").addEventListener("click", () => {
      if (currentIndex > 0) openFullscreen(currentIndex - 1);
    });

    document.getElementById("nextBtn").addEventListener("click", () => {
      if (currentIndex < imageList.length - 1) openFullscreen(currentIndex + 1);
    });

    // Share button copies URL to clipboard
    document.getElementById("shareBtn").addEventListener("click", async () => {
      const img = imageList[currentIndex];
      try {
        await navigator.clipboard.writeText(img.viewUrl);
        alert("Image URL copied to clipboard!");
      } catch {
        alert("Failed to copy URL.");
      }
    });

    window.onload = () => {
      if (checkSession()) loadImages();
    };
  </script>
</body>
</html>
